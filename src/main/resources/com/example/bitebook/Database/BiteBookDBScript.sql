-- MySQL Script generated by MySQL Workbench
-- Mon Nov  3 00:41:39 2025
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema BiteBookDB
-- -----------------------------------------------------
DROP SCHEMA IF EXISTS `BiteBookDB` ;

-- -----------------------------------------------------
-- Schema BiteBookDB
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `BiteBookDB` DEFAULT CHARACTER SET utf8 ;
USE `BiteBookDB` ;

-- -----------------------------------------------------
-- Table `BiteBookDB`.`Dish`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Dish` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Dish` (
  `IdDish` INT NOT NULL AUTO_INCREMENT,
  `Name` VARCHAR(45) NOT NULL,
  `Type` ENUM('APPETIZER', 'FIRST_COURSE', 'MAIN_COURSE', 'SIDE_DISH', 'DESSERT', 'BEVERAGE') NULL,
  `Description` VARCHAR(150) NULL,
  PRIMARY KEY (`IdDish`),
  UNIQUE INDEX `Name_UNIQUE` (`Name` ASC) VISIBLE)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Allergen`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Allergen` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Allergen` (
  `IdAllergen` INT NOT NULL AUTO_INCREMENT,
  `Name` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`idAllergen`),
  UNIQUE INDEX `Name_UNIQUE` (`Name` ASC) VISIBLE)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`AllergensDish`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`AllergensDish` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`AllergensDish` (
  `DishId` INT NOT NULL,
  `AllergenId` INT NOT NULL,
  PRIMARY KEY (`DishId`, `AllergenId`),
  INDEX `fk_AllergensDish_Allergen1_idx` (`AllergenId` ASC) VISIBLE,
  CONSTRAINT `fk_AllergensDish_Dish`
    FOREIGN KEY (`DishId`)
    REFERENCES `BiteBookDB`.`Dish` (`IdDish`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_AllergensDish_Allergen1`
    FOREIGN KEY (`AllergenId`)
    REFERENCES `BiteBookDB`.`Allergen` (`idAllergen`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`User`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`User` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`User` (
  `IdUser` INT NOT NULL AUTO_INCREMENT,
  `Name` VARCHAR(45) NOT NULL,
  `Surname` VARCHAR(45) NOT NULL,
  `Email` VARCHAR(45) NOT NULL,
  `Password` VARCHAR(45) NOT NULL,
  `Role` ENUM('CLIENT', 'CHEF') NOT NULL,
  PRIMARY KEY (`IdUser`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Chef`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Chef` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Chef` (
  `IdChef` INT NOT NULL,
  `City` VARCHAR(45) NOT NULL,
  `CookingStyle` ENUM('CLASSIC', 'MODERN', 'FUSION', 'MOLECULAR', 'ETNIC') NOT NULL,
  PRIMARY KEY (`IdChef`),
  CONSTRAINT `fk_Chef_User1`
    FOREIGN KEY (`IdChef`)
    REFERENCES `BiteBookDB`.`User` (`IdUser`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Menu`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Menu` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Menu` (
  `Idmenu` INT NOT NULL AUTO_INCREMENT,
  `ChefId` INT NOT NULL,
  `Name` VARCHAR(45) NOT NULL,
  `DietType` ENUM('VEGAN', 'VEGETARIAN', 'PESCATARIAN', 'GLUTE_FREE', 'HEALTY', 'NONE') NULL,
  `PricePerPerson` DECIMAL(10,2) NOT NULL,
  -- `MenuLevel` ENUM('BASE', 'PREMIUM', 'LUXE') NOT NULL,
  `PremiumSurcharge` DECIMAL(10,2) NOT NULL,
  `LuxeSurcharge` DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (`Idmenu`),
  INDEX `fk_Menu_Chef1_idx` (`ChefId` ASC) VISIBLE,
  CONSTRAINT `fk_Menu_Chef1`
    FOREIGN KEY (`ChefId`)
    REFERENCES `BiteBookDB`.`Chef` (`IdChef`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`MenuComposition`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`MenuComposition` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`MenuComposition` (
  `DishId` INT NOT NULL,
  `MenuId` INT NOT NULL,
  PRIMARY KEY (`DishId`, `MenuId`),
  INDEX `fk_MenuComposition_Menu1_idx` (`MenuId` ASC) VISIBLE,
  CONSTRAINT `fk_MenuComposition_Dish1`
    FOREIGN KEY (`DishId`)
    REFERENCES `BiteBookDB`.`Dish` (`IdDish`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_MenuComposition_Menu1`
    FOREIGN KEY (`MenuId`)
    REFERENCES `BiteBookDB`.`Menu` (`Idmenu`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Client`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Client` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Client` (
  `IdClient` INT NOT NULL,
  PRIMARY KEY (`IdClient`),
  CONSTRAINT `fk_Client_User1`
    FOREIGN KEY (`IdClient`)
    REFERENCES `BiteBookDB`.`User` (`IdUser`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Allergies`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Allergies` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Allergies` (
  `ClientId` INT NOT NULL,
  `AllergenId` INT NOT NULL,
  PRIMARY KEY (`ClientId`, `AllergenId`),
  INDEX `fk_Allergies_Allergen1_idx` (`AllergenId` ASC) VISIBLE,
  CONSTRAINT `fk_Allergies_Client1`
    FOREIGN KEY (`ClientId`)
    REFERENCES `BiteBookDB`.`Client` (`IdClient`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Allergies_Allergen1`
    FOREIGN KEY (`AllergenId`)
    REFERENCES `BiteBookDB`.`Allergen` (`idAllergen`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`Specializations`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`Specializations` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`Specializations` (
  `ChefId` INT NOT NULL,
  `Specialization` ENUM('ITALIAN', 'FRENCH', 'JAPANESE', 'VEGETARIAN', 'VEGAN', 'PASTRY', 'SEAFOOD') NOT NULL,
  PRIMARY KEY (`ChefId`, `Specialization`),
  CONSTRAINT `fk_Specialization_Chef1`
    FOREIGN KEY (`ChefId`)
    REFERENCES `BiteBookDB`.`Chef` (`IdChef`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `BiteBookDB`.`ServiceRequest`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `BiteBookDB`.`ServiceRequest` ;

CREATE TABLE IF NOT EXISTS `BiteBookDB`.`ServiceRequest` (
  `IdServiceRequest` INT NOT NULL AUTO_INCREMENT,
  `ClientId` INT NOT NULL,
  `ChefId` INT NOT NULL,
  `MenuId` INT NOT NULL,
  `SelectedMenuLevel` ENUM('BASE', 'PREMIUM', 'LUXE') NOT NULL,    -- Aggiunto dopo 
  `TotalPrice` DECIMAL(10,2) NOT NULL,
  `Status` ENUM('PENDING', 'APPROVED', 'REJECTED') NOT NULL,
  `Date` DATE NOT NULL,
  `Time` VARCHAR(45) NOT NULL,
  `Address` VARCHAR(45) NOT NULL,
  `ParticipantsNumber` INT NOT NULL,
  PRIMARY KEY (`IdServiceRequest`),
  INDEX `fk_ServiceRequest_Client1_idx` (`ClientId` ASC) VISIBLE,
  INDEX `fk_ServiceRequest_Chef1_idx` (`ChefId` ASC) VISIBLE,
  INDEX `fk_ServiceRequest_Menu1_idx` (`MenuId` ASC) VISIBLE,
  CONSTRAINT `fk_ServiceRequest_Client1`
    FOREIGN KEY (`ClientId`)
    REFERENCES `BiteBookDB`.`Client` (`IdClient`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_ServiceRequest_Chef1`
    FOREIGN KEY (`ChefId`)
    REFERENCES `BiteBookDB`.`Chef` (`IdChef`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_ServiceRequest_Menu1`
    FOREIGN KEY (`MenuId`)
    REFERENCES `BiteBookDB`.`Menu` (`Idmenu`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

-- --------------------------------------------
-- Trigger
-- --------------------------------------------


-- Trigger per impedire l'inserimento in CLIENT se il ruolo in USER non è 'CLIENT'

DELIMITER $$
CREATE TRIGGER check_chef_not_client
BEFORE INSERT ON Client
FOR EACH ROW
BEGIN
    DECLARE user_role ENUM('CLIENT', 'CHEF');
    
    -- Recupera il ruolo dell'utente che si sta tentando di inserire in Client
    SELECT Role INTO user_role 
    FROM User 
    WHERE IdUser = NEW.IdClient;

    -- Se il ruolo è 'CHEF' (o qualsiasi cosa diversa da 'CLIENT'), solleva un errore
    IF user_role != 'CLIENT' THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ERRORE: Impossibile inserire un utente che non è un CLIENT nella tabella Client.';
    END IF;
END$$
DELIMITER ;


-- Trigger per impedire l'inserimento in CHEF se il ruolo in USER non è 'CHEF'

DELIMITER $$
CREATE TRIGGER check_client_not_chef
BEFORE INSERT ON Chef
FOR EACH ROW
BEGIN
    DECLARE user_role ENUM('CLIENT', 'CHEF');
    
    -- Recupera il ruolo dell'utente che si sta tentando di inserire in Chef
    SELECT Role INTO user_role 
    FROM User 
    WHERE IdUser = NEW.IdChef;

    -- Se il ruolo è 'CLIENT' (o qualsiasi cosa diversa da 'CHEF'), solleva un errore
    IF user_role != 'CHEF' THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ERRORE: Impossibile inserire un utente che non è un CHEF nella tabella Chef.';
    END IF;
END$$
DELIMITER ;


-- Trigger per inserire automaticamente l'utente nella tabella del ruolo corrispondente.

DELIMITER $$
CREATE TRIGGER auto_insert_role_after_user_insert
AFTER INSERT ON User
FOR EACH ROW
BEGIN
    IF NEW.Role = 'CLIENT' THEN
        -- Inserisce l'ID dell'utente appena creato nella tabella Client
        INSERT INTO Client (IdClient)
        VALUES (NEW.IdUser);
    
    ELSEIF NEW.Role = 'CHEF' THEN
        -- Inserisce l'ID dell'utente appena creato nella tabella Chef
        -- Vengono forniti valori placeholder per City e CookingStyle perché sono NOT NULL.
        INSERT INTO Chef (IdChef, City, CookingStyle)
        VALUES (NEW.IdUser, 'DA_DEFINIRE', 'CLASSIC'); 
    END IF;
END$$
DELIMITER ;


-- Trigger per sincronizzare le tabelle dei ruoli dopo l'aggiornamento del ruolo in User

DELIMITER $$
CREATE TRIGGER sync_role_after_user_update
AFTER UPDATE ON User
FOR EACH ROW
BEGIN
    -- Verifica se il campo Role è stato effettivamente modificato
    IF OLD.Role != NEW.Role THEN
        
        -- Caso 1: Da CLIENT a CHEF
        IF OLD.Role = 'CLIENT' AND NEW.Role = 'CHEF' THEN
            -- 1. Rimuove la riga da Client
            DELETE FROM Client WHERE IdClient = NEW.IdUser;
            
            -- 2. Inserisce la riga in Chef (con valori placeholder)
            INSERT INTO Chef (IdChef, City, CookingStyle)
            VALUES (NEW.IdUser, 'DA_DEFINIRE', 'CLASSIC'); 
        
        -- Caso 2: Da CHEF a CLIENT (o GUEST se lo prevedi)
        ELSEIF OLD.Role = 'CHEF' AND NEW.Role = 'CLIENT' THEN
            -- 1. Rimuove la riga da Chef
            DELETE FROM Chef WHERE IdChef = NEW.IdUser;
            
            -- 2. Inserisce la riga in Client
            INSERT INTO Client (IdClient)
            VALUES (NEW.IdUser);
        END IF;
    END IF;
END$$
DELIMITER ;



-- ---------------------------------------------------
-- Le Insert
-- ---------------------------------------------------

-- ********************************************
-- 1. UTENTI (USER)
-- ********************************************


INSERT INTO User (IdUser, Name, Surname, Email, Password, Role) VALUES
(1, 'Marco', 'Rossi', 'mrossi@mail.it', 'password12', 'CLIENT'),
(2, 'Sofia', 'Bianchi', 'sbianchi@mail.it', 'password12', 'CLIENT'),
(3, 'Carlo', 'Verdi', 'cverdi@chef.it', 'password12', 'CHEF'),
(4, 'Laura', 'Neri', 'lneri@chef.it', 'password12', 'CHEF'),
(5, 'Giulia', 'Russo', 'grusso@mail.it', 'password12', 'CLIENT'),
(6, 'Andrea', 'Moro', 'amoro@mail.it', 'password12', 'CLIENT'),
(7, 'Davide', 'Galli', 'dgalli@chef.it', 'password12', 'CHEF'),
(8, 'Elena', 'Bassi', 'ebassi@chef.it', 'password12', 'CHEF'),
(9, 'Luca', 'Esposito', 'lesposito@mail.it', 'password12', 'CLIENT'),
(10, 'Chiara', 'Ferrara', 'cferrara@mail.it', 'password12', 'CLIENT'),
(11, 'Matteo', 'Conti', 'mconti@mail.it', 'password12', 'CLIENT'),
(12, 'Francesca', 'Riva', 'friva@chef.it', 'password12', 'CHEF'),
(13, 'Giovanni', 'Lodi', 'glodi@chef.it', 'password12', 'CHEF'),
(14, 'Sara', 'Monti', 'smonti@chef.it', 'password12', 'CHEF'),
(15, 'Antonio', 'Bruno', 'abruno@mail.it', 'password12', 'CLIENT'), 
(16, 'Valeria', 'Gialli', 'vgialli@mail.it', 'password12', 'CLIENT'), 
(17, 'Riccardo', 'Sanna', 'rsanna@chef.it', 'password12', 'CHEF'),
(18, 'Paola', 'Fanti', 'pfanti@chef.it', 'password12', 'CHEF'),
(19, 'Mauro', 'Leoni', 'mleoni@chef.it', 'password12', 'CHEF');




-- ********************************************
-- 2. DETTAGLI CHEF (CHEF)
-- ********************************************


UPDATE Chef SET City = 'Rome', CookingStyle = 'CLASSIC' WHERE IdChef = 3;
UPDATE Chef SET City = 'Milan', CookingStyle = 'FUSION' WHERE IdChef = 4;
UPDATE Chef SET City = 'Turin', CookingStyle = 'MODERN' WHERE IdChef = 7;
UPDATE Chef SET City = 'Rome', CookingStyle = 'CLASSIC' WHERE IdChef = 8;
UPDATE Chef SET City = 'Florence', CookingStyle = 'ETNIC' WHERE IdChef = 12;
UPDATE Chef SET City = 'Bologna', CookingStyle = 'MODERN' WHERE IdChef = 13;
UPDATE Chef SET City = 'Bari', CookingStyle = 'CLASSIC' WHERE IdChef = 14;
UPDATE Chef SET City = 'Venice', CookingStyle = 'CLASSIC' WHERE IdChef = 17;
UPDATE Chef SET City = 'Rome', CookingStyle = 'MODERN' WHERE IdChef = 18;
UPDATE Chef SET City = 'Rome', CookingStyle = 'FUSION' WHERE IdChef = 19; -- Nuovo Stile




-- ********************************************
-- 3. ALLERGENI (ALLERGEN)
-- ********************************************


INSERT INTO Allergen (idAllergen, Name) VALUES
(1, 'Gluten'),
(2, 'Milk'),
(3, 'Egg'),
(4, 'Fish'),
(5, 'Nuts'),
(6, 'Soy'),
(7, 'Crustaceans'),
(8, 'Celery'),
(9, 'Mustard'),
(10, 'Mushrooms'),
(11, 'Peanuts'),
(12, 'Cereals');




-- ********************************************
-- 4. PIATTI (DISH)
-- ********************************************


INSERT INTO Dish (IdDish, Name, Type, Description) VALUES
(101, 'Mushroom Risotto', 'FIRST_COURSE', 'Creamy risotto with porcini mushrooms'),
(102, 'Classic Tiramisu', 'DESSERT', 'Ladyfingers and mascarpone cream'),
(103, 'Steamed Salmon', 'MAIN_COURSE', 'Salmon with aromatic herbs'),
(104, 'Gnocchi with Pesto', 'FIRST_COURSE', 'Homemade gnocchi with fresh pesto'),
(105, 'Roast Veal', 'MAIN_COURSE', 'Low-temperature cooked roast'),
(106, 'Chocolate Mousse', 'DESSERT', 'Light dark chocolate mousse'),
(107, 'Red Wine', 'BEVERAGE', 'A classic Chianti'),
(108, 'Mixed Sushi', 'FIRST_COURSE', 'Selection of nigiri and uramaki'),
(109, 'Vegan Panna Cotta', 'DESSERT', 'Coconut milk and vanilla based dessert'),
(110, 'Veggie Burger', 'MAIN_COURSE', 'Legume and vegetable based burger'),
(111, 'Seafood Soup', 'FIRST_COURSE', 'Soup with mollusks and crustaceans'),
(112, 'Vegetarian Quiche', 'MAIN_COURSE', 'Savory pie with vegetables'),
(113, 'Hollandaise Sauce', 'SIDE_DISH', 'Rich and buttery sauce'),
(114, 'Shrimp Curry', 'MAIN_COURSE', 'Spicy ethnic dish'),
(115, 'Spaghetti Carbonara', 'FIRST_COURSE', 'Pasta with eggs, pecorino cheese, and guanciale'),
(116, 'Grilled Chicken Salad', 'MAIN_COURSE', 'Fresh salad with grilled chicken breast and croutons'),
(117, 'Pumpkin Velouté', 'FIRST_COURSE', 'Creamy pumpkin soup with nutmeg and cream'),
(118, 'Apple Pie', 'DESSERT', 'Traditional pie with cinnamon apples and crust'),
(119, 'Fish and Chips', 'MAIN_COURSE', 'Fried battered cod with crispy chips'),
(120, 'Caprese Salad', 'SIDE_DISH', 'Sliced fresh mozzarella, tomatoes, and sweet basil'),
(121, 'Eggplant Parmigiana', 'MAIN_COURSE', 'Baked eggplant with tomato sauce and mozzarella'),
(122, 'Pistachio Baklava', 'DESSERT', 'Layered pastry filled with chopped nuts and honey'),
(123, 'Mashed Potatoes', 'SIDE_DISH', 'Potatoes mashed with butter and milk'),
(124, 'Beef Tacos', 'MAIN_COURSE', 'Corn tortillas filled with seasoned beef and cheese'),
(125, 'Peanut Butter Cookies', 'DESSERT', 'Crunchy cookies made with roasted peanuts'),
(126, 'Lobster Bisque', 'FIRST_COURSE', 'Creamy soup made with fresh lobster meat'),
(127, 'Falafel Plate', 'MAIN_COURSE', 'Fried chickpea balls served with hummus and tahini'),
(128, 'Beef Wellington', 'MAIN_COURSE', 'Filet steak coated with pâté and puff pastry'),
(129, 'Greek Salad', 'SIDE_DISH', 'Fresh salad with feta cheese, olives, and cucumber'),
(130, 'Pad Thai', 'MAIN_COURSE', 'Stir-fried noodles with shrimp, peanuts, and egg'),
(131, 'Lemon Sorbet', 'DESSERT', 'Refreshing dairy-free frozen dessert'),
(132, 'Macaroni and Cheese', 'FIRST_COURSE', 'Pasta baked in a rich creamy cheese sauce'),
(133, 'Gazpacho', 'FIRST_COURSE', 'Cold Spanish soup made of raw blended vegetables'),
(134, 'Crème Brûlée', 'DESSERT', 'Rich custard base topped with caramelized sugar');




-- ********************************************
-- 5. ALLERGENI PIATTO (ALLERSENDISH)
-- ********************************************


INSERT INTO AllergensDish (DishId, AllergenId) VALUES
(101, 2), (101, 8), (101, 10),
(102, 1), (102, 12), (102, 2), (102, 3),
(103, 4),
(104, 1), (104, 12), (104, 2), (104, 3), (104, 5),
(105, 8),
(106, 2), (106, 3),
(108, 4), (108, 7), (108, 6),
(110, 1), (110, 12), (110, 6), (110, 8),
(111, 4), (111, 7), (111, 8),
(112, 1), (112, 12), (112, 2), (112, 3),
(113, 3), (113, 2),
(114, 7), (114, 9), (114, 8), (114, 2),
(115, 1), (115, 12), (115, 3), (115, 2),
(116, 1), (116, 12), (116, 2), (116, 9),
(117, 2), (117, 8),
(118, 1), (118, 12), (118, 2),
(119, 4), (119, 1), (119, 12),
(120, 2),
(121, 2), (121, 1), (121, 12), (121, 8),
(122, 5), (122, 1), (122, 12), (122, 2),
(123, 2),
(124, 2),
(125, 11), (125, 1), (125, 12), (125, 3), (125, 2),
(126, 7), (126, 2), (126, 4), (126, 8),
(127, 1), (127, 12),
(128, 1), (128, 12), (128, 3), (128, 2), (128, 9),
(129, 2),
(130, 7), (130, 11), (130, 3), (130, 4), (130, 6),
(132, 1), (132, 12), (132, 2), (132, 9),
(133, 1), (133, 12), (133, 8),
(134, 3), (134, 2);





-- ********************************************
-- 6. MENU (MENU)
-- ********************************************


INSERT INTO Menu (Idmenu, ChefId, Name, DietType, PricePerPerson, PremiumSurcharge, LuxeSurcharge) VALUES
(201, 3, 'Classic Tasting Menu', 'NONE', 50.00, 10.00, 25.00),
(202, 4, 'Veggie Fusion Menu', 'VEGETARIAN', 45.00, 15.00, 30.00),
(203, 7, 'Land & Earth Menu', 'NONE', 65.00, 15.00, 35.00),
(204, 8, 'Healthy & Light Menu', 'HEALTY', 40.00, 10.00, 20.00),
(205, 3, 'Seafood Experience', 'PESCATARIAN', 70.00, 20.00, 40.00),
(206, 12, 'Complete Vegan Menu', 'VEGAN', 55.00, 15.00, 25.00),
(207, 13, 'Japanese Special', 'NONE', 80.00, 20.00, 45.00),
(208, 17, 'Venetian Lagoon', 'PESCATARIAN', 75.00, 25.00, 50.00),
(209, 18, 'Allergen-Free Delight', 'HEALTY', 50.00, 10.00, 20.00),
(210, 3, 'Gourmet French Menu', 'NONE', 90.00, 10.00, 30.00),
(211, 19, 'Oriental Flavors', 'NONE', 60.00, 15.00, 30.00),
(212, 14, 'Apulian Classics', 'NONE', 55.00, 12.00, 22.00);




-- ********************************************
-- 7. COMPOSIZIONE MENU (MENUCOMPOSITION)
-- ********************************************


INSERT INTO MenuComposition (DishId, MenuId) VALUES
(101, 201), -- Mushroom Risotto
(115, 201), -- Spaghetti Carbonara (Nuovo)
(102, 201), -- Classic Tiramisu

(104, 202), -- Gnocchi with Pesto
(121, 202), -- Eggplant Parmigiana (Nuovo)
(122, 202), -- Pistachio Baklava (Nuovo)

(117, 203), -- Pumpkin Velouté (Nuovo)
(128, 203), -- Beef Wellington (Nuovo - Molto "Terra")
(123, 203), -- Mashed Potatoes (Nuovo)
(118, 203), -- Apple Pie (Nuovo)

(129, 204), -- Greek Salad (Nuovo)
(116, 204), -- Grilled Chicken Salad (Nuovo)
(131, 204), -- Lemon Sorbet (Nuovo)

(126, 205), -- Lobster Bisque (Nuovo)
(103, 205), -- Steamed Salmon
(113, 205), -- Hollandaise Sauce

(133, 206), -- Gazpacho (Nuovo)
(127, 206), -- Falafel Plate (Nuovo)
(109, 206), -- Vegan Panna Cotta

(108, 207), -- Mixed Sushi
(130, 207), -- Pad Thai (Nuovo - Pan-Asian)
(107, 207), -- Red Wine

(111, 208), -- Seafood Soup
(119, 208), -- Fish and Chips (Nuovo - Versione moderna del fritto misto)
(106, 208), -- Chocolate Mousse

(120, 209), -- Caprese Salad (Nuovo - Senza glutine)
(105, 209), -- Roast Veal
(131, 209), -- Lemon Sorbet (Nuovo)

(126, 210), -- Lobster Bisque (Nuovo)
(128, 210), -- Beef Wellington (Nuovo - Anche se inglese, molto gourmet)
(134, 210), -- Crème Brûlée (Nuovo - Molto Francese)

(114, 211), -- Shrimp Curry
(125, 211), -- Peanut Butter Cookies (Nuovo)
(130, 211), -- Pad Thai (Nuovo)

(120, 212), -- Caprese Salad (Nuovo)
(111, 212), -- Seafood Soup (Tipico Bari)
(102, 212); -- Tiramisu




-- ********************************************
-- 8. SPECIALIZZAZIONI CHEF (SPECIALIZATIONS)
-- ********************************************


INSERT INTO Specializations (ChefId, Specialization) VALUES
(3, 'ITALIAN'), (3, 'FRENCH'), (3, 'SEAFOOD'), 
(4, 'VEGETARIAN'), 
(7, 'ITALIAN'), 
(8, 'PASTRY'), (8, 'ITALIAN'),
(12, 'VEGAN'), 
(13, 'JAPANESE'), 
(14, 'SEAFOOD'), (14, 'ITALIAN'), 
(17, 'SEAFOOD'), (17, 'ITALIAN'),
(18, 'PASTRY'), 
(19, 'JAPANESE');




-- ********************************************
-- 9. ALLERGIE CLIENTI (ALLERGIES)
-- ********************************************


INSERT INTO Allergies (ClientId, AllergenId) VALUES
(1, 1),  -- Gluten
(1, 12), -- Cereals (Spesso chi è allergico al glutine evita tutti i cereali)

(2, 4),  -- Fish
(2, 7),  -- Crustaceans (Aggiunto per completezza)

(5, 5),  -- Nuts
(5, 11), -- Peanuts (Nuovo! Spesso chi è allergico alle noci lo è anche alle arachidi)

(6, 11), -- Peanuts

(9, 2),  -- Milk

(10, 3), -- Egg
(10, 9), -- Mustard (Nuovo! Attenzione alle salse)

(11, 10), -- Mushrooms (Niente Risotto ai funghi per lui)
(11, 8),  -- Celery (Attenzione a brodi e soffritti)

(15, 1),  -- Gluten
(15, 2),  -- Milk
(15, 3),  -- Egg
(15, 12), -- Cereals
(15, 6),  -- Soy (Nuovo! Molto comune nei prodotti lavorati)

(16, 7), -- Crustaceans
(16, 4); -- Fish






-- Pulizia preliminare
DROP PROCEDURE IF EXISTS GetCredentialsRole;
DROP PROCEDURE IF EXISTS GetChefInfo;
DROP PROCEDURE IF EXISTS GetChefSpecilizations;

-- -----------------------------------------------------------------
-- 1. Autenticazione: GetCredentialsRole
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE GetCredentialsRole(
	IN p_email VARCHAR(255), 
	IN p_password VARCHAR(255)
)
BEGIN
    SELECT Role as UserRole
    FROM User
    WHERE Email = p_email AND Password = p_password
    LIMIT 1;
END$$

DELIMITER ;

-- -----------------------------------------------------------------
-- 2. Dettagli Base Chef: GetChefInfo
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE GetChefInfo(
	IN p_email VARCHAR(255), 
	IN p_password VARCHAR(255)
)
BEGIN
	SELECT U.IdUser,U.Name,U.Surname,U.Email,U.Role,C.CookingStyle,C.City
	FROM User U JOIN Chef C ON U.IdUser = C.IdChef
	WHERE U.Email = p_email AND U.Password = p_password
	LIMIT 1;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 2.1 Dettagli Client: GetClientInfo
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE GetClientInfo(
	IN p_email VARCHAR(255), 
	IN p_password VARCHAR(255)
)
BEGIN
	SELECT U.IdUser,U.Name,U.Surname,U.Email
	FROM User U JOIN Client C ON U.IdUser = C.IdClient
	WHERE U.Email = p_email AND U.Password = p_password
	LIMIT 1;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 3. Specializzazioni: GetChefSpecilizations
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE GetChefSpecializations(
	IN chef_id INT
)
BEGIN
	SELECT Specialization
	FROM   Specializations as S
	WHERE S.ChefId = chef_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 3. Allergies: GetCSpecilizations
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE GetClientAllergies(
	IN client_id INT
)
BEGIN
	SELECT A.IdAllergen as AllergenId, A.Name as AllergenName
	FROM   Allergies JOIN Allergen A ON Allergies.AllergenId = A.IdAllergen
	WHERE  ClientId = client_id;
END$$

DELIMITER ;



-- -----------------------------------------------------------------
-- 4. Vector<Chef>: FindCityChefs
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE FindCityChefs(
	IN city VARCHAR(45)
)
BEGIN
	SELECT 	IdChef
    FROM 	Chef as C JOIN User U ON C.IdChef = U.IdUser
    WHERE	C.City = city;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 4. Vector<Chef>: getChefsInCity
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE getChefsInCity(
	IN city VARCHAR(45)
)
BEGIN
	SELECT U.IdUser AS IdChef, U.Name AS Name, U.Surname AS Surname, C.CookingStyle, GROUP_CONCAT(S.Specialization SEPARATOR ', ') AS Specializations
	FROM User U JOIN Chef C ON U.IdUser = C.IdChef LEFT JOIN Specializations S ON C.IdChef = S.ChefId 
	WHERE C.City = city  
    GROUP BY U.IdUser, U.Name, U.Surname, C.CookingStyle
    ORDER BY U.Surname, U.Name;
END$$

DELIMITER ;



-- -----------------------------------------------------------------
-- 5. Vector<Menu>: getChefMenus
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE getChefMenus(
	IN  chef_id INT
)
BEGIN
	SELECT 	M.Idmenu, M.Name, M.DietType, M.PricePerPerson, COUNT(MC.MenuId) AS NumberOfCourses
	FROM	Menu M 
	JOIN	MenuComposition MC ON M.Idmenu = MC.MenuId
	WHERE	M.ChefId = chef_id
	GROUP BY M.Idmenu, M.Name, M.DietType, M.PricePerPerson 
	ORDER BY M.Idmenu;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 6. Vector<Dish>: getMenuCourses
-- -----------------------------------------------------------------
DELIMITER $$

CREATE PROCEDURE getMenuCourses(
	IN  menu_id INT
)
BEGIN
	SELECT 	IdDish, Name, Type, Description
    FROM	Dish D JOIN MenuComposition MC ON D.IdDish = MC.DishId
    WHERE	MC.MenuId = menu_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 6. Vector<Allergen>: getDishAllergens
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getDishAllergens(
	IN  dish_id INT
)
BEGIN
	SELECT 	IdAllergen, Name
    FROM	Allergen A JOIN AllergensDish AD ON A.IdAllergen = AD.AllergenId
    WHERE	AD.DishId = dish_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 7. getMenuLevelsSurcharge
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getMenuLevelsSurcharge(
	IN  menu_id INT
)
BEGIN
	SELECT 	PremiumSurcharge, LuxeSurcharge
    FROM	Menu
    WHERE	Idmenu = menu_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 8. getChefFromMenu
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getChefFromMenu(
	IN  menu_id INT
)
BEGIN
	SELECT 	C.IdChef as ChefId, U.Name as ChefName, U.Surname as ChefSurname
    FROM	Menu M JOIN Chef C ON M.ChefId = C.IdChef JOIN User U ON C.IdChef = U.IdUser
    WHERE	Idmenu = menu_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 9. saveServiceRequest
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE saveServiceRequest(
	IN client_id INT,
    IN chef_id INT,
    IN menu_id INT,
    IN selectedMenuLevel ENUM('BASE','PREMIUM','LUXE'),
    IN total_price INT,
    IN request_status ENUM('PENDING','APPROVED','REJECTED'),
    IN req_date Date,
    IN req_time Time,
    IN address VARCHAR(45),
    IN participants_number INT
)
BEGIN
	INSERT INTO ServiceRequest(ClientId, ChefId, MenuId, SelectedMenuLevel, TotalPrice, Status, Date, Time, Address, ParticipantsNumber) VALUES
    ( client_id, chef_id, menu_id, selectedMenuLevel, total_price, request_status, req_date, req_time, address, participants_number);
END$$

DELIMITER ;



-- -----------------------------------------------------------------
-- 10. getClientRequests
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getClientRequests(
	IN client_id INT
)
BEGIN
	SELECT	IdServiceRequest as RequestId, U.Name as ChefName, U.Surname as ChefSurname, M.Name as MenuName, SelectedMenuLevel as MenuLevel, ParticipantsNumber, TotalPrice, Date, Time, Address, Status
    FROM 	ServiceRequest SR JOIN Chef C ON SR.ChefId = C.IdChef JOIN User U ON C.IdChef = U.IdUser JOIN Menu M ON SR.MenuId = M.Idmenu
    WHERE 	SR.clientId = client_id
    ORDER BY Date;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 11. removeClientAllergy
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE removeClientAllergy(
	IN client_id INT,
	IN allergen_id INT
)
BEGIN
	DELETE FROM Allergies
    WHERE	ClientId = client_id AND AllergenId = allergen_id;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 12. getAllergens
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getAllergens(
)
BEGIN
	SELECT *
    FROM Allergen
    ORDER BY IdAllergen;
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 13. insertAllergy
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE insertAllergy(
    IN client_id INT,
	IN allergen_id INT
)
BEGIN
	INSERT IGNORE INTO Allergies (ClientId, AllergenId) VALUES (client_id, allergen_id);
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 14. getChefRequests
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE getChefRequests(
	IN chef_id INT
)
BEGIN
	SELECT	IdServiceRequest as RequestId, U.Name as ClientName, U.Surname as ClientSurname, M.Name as MenuName, SelectedMenuLevel as MenuLevel, ParticipantsNumber, TotalPrice, Date, Time, Address, Status
    FROM 	ServiceRequest SR JOIN Client C ON SR.ClientId = C.IdClient JOIN User U ON C.IdClient = U.IdUser JOIN Menu M ON SR.MenuId = M.Idmenu
    WHERE 	SR.ChefId = chef_id
    ORDER BY Date;
END$$

DELIMITER ;



-- -----------------------------------------------------------------
-- 15. approveRequest
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE approveRequest(
	IN request_id INT
)
BEGIN
	-- UPDATE Chef SET City = 'Roma', CookingStyle = 'CLASSIC' WHERE IdChef = 3;
	UPDATE ServiceRequest SET Status = 'APPROVED' WHERE IdServiceRequest = request_id AND Status = 'PENDING';
END$$

DELIMITER ;


-- -----------------------------------------------------------------
-- 16. rejectRequest
-- -----------------------------------------------------------------

DELIMITER $$

CREATE PROCEDURE rejectRequest(
	IN request_id INT
)
BEGIN
	-- UPDATE Chef SET City = 'Roma', CookingStyle = 'CLASSIC' WHERE IdChef = 3;
	UPDATE ServiceRequest SET Status = 'REJECTED' WHERE IdServiceRequest = request_id AND Status = 'PENDING';
END$$

DELIMITER ;






CALL getChefRequests(19);


GRANT EXECUTE ON PROCEDURE bitebookdb.GetCredentialsRole TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetChefInfo TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetClientInfo TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetChefSpecializations TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetClientInfo TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.FindCityChefs TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetChefsInCity TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetChefMenus TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetMenuCourses TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.GetDishAllergens TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.getMenuLevelsSurcharge TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.getChefFromMenu TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.saveServiceRequest TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.getClientRequests TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.removeClientAllergy TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.getAllergens TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.insertAllergy TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.getChefRequests TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.approveRequest TO 'root'@'localhost';
GRANT EXECUTE ON PROCEDURE bitebookdb.rejectRequest TO 'root'@'localhost';
FLUSH PRIVILEGES;



-- Query per i file CSV del progetto




-- Query per ottenere tutte le informazioni degli utenti 
	SELECT 	IdUser, Name, Surname, Email, Password, Role, City, CookingStyle
    FROM	User left JOIN Chef ON IdChef = IdUser;

	-- Il risultato va inserito nel file CSV Users 


-- Query per ottenere tutte le associazioni tra Utente, le sue allergie a il nome dell'allergie
	SELECT C.IdClient, A.IdAllergen as AllergenId, A.Name as AllergenName
	FROM   Client C JOIN Allergies ON C.IdClient = ClientId  JOIN Allergen A ON Allergies.AllergenId = A.IdAllergen;
    
    -- Il risultato va inserito nel file CSV ClientAllergies


-- Query per ottenere tutte le specializzazioni dello chef
	SELECT *
    FROM Specializations;
    
    -- Il risultato va inserito nel file CSV ChefsSpecializations



